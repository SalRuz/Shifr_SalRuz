<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D –õ–∞–±–∏—Ä–∏–Ω—Ç —Å –≤—Ä–∞–≥–∞–º–∏</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Courier New', monospace;
            color: #ff0000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
        }
        
        #game-canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }
        
        #ui {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 20px;
            box-sizing: border-box;
        }
        
        #health {
            font-size: 24px;
            color: #ff0000;
            text-shadow: 0 0 5px #ff0000;
        }
        
        #weapon {
            width: 300px;
            height: 180px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="180" viewBox="0 0 300 180"><path d="M150,180 L140,120 L160,120 Z" fill="%23333"/><rect x="130" y="80" width="40" height="40" fill="%23555"/><rect x="135" y="85" width="30" height="30" fill="%23777"/></svg>') no-repeat center bottom;
            image-rendering: pixelated;
            transition: transform 0.1s;
        }
        
        #weapon.shooting {
            transform: translateY(10px);
        }
        
        #ammo {
            font-size: 24px;
            color: #ffcc00;
            text-shadow: 0 0 5px #ffcc00;
        }
        
        #instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border: 2px solid #ff0000;
            font-size: 14px;
        }
        
        #map {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid #ff0000;
        }
        
        #game-over, #game-win {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #game-over h1, #game-win h1 {
            font-size: 48px;
            color: #ff0000;
            margin-bottom: 20px;
        }
        
        #restart-button {
            padding: 10px 20px;
            background-color: #ff0000;
            color: #000;
            border: none;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .blood-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div class="blood-effect" id="blood-effect"></div>
        
        <div id="ui">
            <div id="health">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            <div id="weapon"></div>
            <div id="ammo">üî´ ‚àû</div>
        </div>
        
        <div id="instructions">
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: WASD - –¥–≤–∏–∂–µ–Ω–∏–µ</p>
            <p>–°—Ç—Ä–µ–ª–∫–∏ - –ø–æ–≤–æ—Ä–æ—Ç, E - –≤—ã—Å—Ç—Ä–µ–ª</p>
            <p>M - –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</p>
        </div>
        
        <canvas id="map"></canvas>
        
        <div id="game-over">
            <h1>–í–´ –ü–†–û–ò–ì–†–ê–õ–ò</h1>
            <p>–í–∞—Å —Å—ä–µ–ª–∏ –º–æ–Ω—Å—Ç—Ä—ã –ª–∞–±–∏—Ä–∏–Ω—Ç–∞</p>
            <button id="restart-button">–ó–ê–ù–û–í–û</button>
        </div>
        
        <div id="game-win">
            <h1>–ü–û–ë–ï–î–ê!</h1>
            <p>–í—ã —É–Ω–∏—á—Ç–æ–∂–∏–ª–∏ –≤—Å–µ—Ö –º–æ–Ω—Å—Ç—Ä–æ–≤</p>
            <button id="restart-button-win">–ó–ê–ù–û–í–û</button>
        </div>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const mapCanvas = document.getElementById('map');
        const mapCtx = mapCanvas.getContext('2d');
        const healthDisplay = document.getElementById('health');
        const ammoDisplay = document.getElementById('ammo');
        const weaponElement = document.getElementById('weapon');
        const gameOverScreen = document.getElementById('game-over');
        const gameWinScreen = document.getElementById('game-win');
        const bloodEffect = document.getElementById('blood-effect');
        const restartButton = document.getElementById('restart-button');
        const restartButtonWin = document.getElementById('restart-button-win');
        
        canvas.width = 800;
        canvas.height = 600;
        mapCanvas.width = 150;
        mapCanvas.height = 150;
        
        // –†–∞–∑–º–µ—Ä—ã –∏–≥—Ä–æ–≤–æ–≥–æ –º–∏—Ä–∞
        const mapSize = 16;
        const tileSize = 64;
        
        // –õ–∞–±–∏—Ä–∏–Ω—Ç (1 - —Å—Ç–µ–Ω—ã, 0 - –ø—Ä–æ—Ö–æ–¥—ã)
        const map = [
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1],
            [1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1],
            [1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1],
            [1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1],
            [1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1],
            [1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1],
            [1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1],
            [1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
        ];
        
        // –ü–æ–∑–∏—Ü–∏—è –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        let playerX = 1.5 * tileSize;
        let playerY = 1.5 * tileSize;
        let playerAngle = 0;
        const playerSpeed = 3;
        const rotationSpeed = 0.05;
        
        // –ó–¥–æ—Ä–æ–≤—å–µ –∏–≥—Ä–æ–∫–∞
        let playerHealth = 3;
        let playerInvulnerable = false;
        
        // –í—Ä–∞–≥–∏
        let enemies = [];
        const enemySpeed = 1.5;
        const enemySize = 20;
        let enemySpawnTimer = 0;
        const enemySpawnInterval = 10000; // 10 —Å–µ–∫—É–Ω–¥
        
        // –û—Ä—É–∂–∏–µ
        let isShooting = false;
        let shootCooldown = 0;
        const shootCooldownTime = 500; // 0.5 —Å–µ–∫—É–Ω–¥—ã
        
        // –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω —Å—Ç–µ–Ω
        const wallColors = {
            north: '#8b0000',  // —Ç—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
            south: '#a52a2a',  // –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π
            east: '#b22222',   // –æ–≥–Ω–µ–Ω–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π
            west: '#800000'    // –º–∞—Ä—Å–∞–ª–∞
        };
        
        // –¶–≤–µ—Ç–∞ –¥–ª—è –ø–æ–ª–∞ –∏ –ø–æ—Ç–æ–ª–∫–∞
        const floorColor = '#333333';
        const ceilingColor = '#111111';
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        const keys = {
            w: false,
            a: false,
            s: false,
            d: false,
            ArrowLeft: false,
            ArrowRight: false,
            e: false
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        window.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = true;
            }
            
            // –í—ã—Å—Ç—Ä–µ–ª
            if (e.key === 'e' || e.key === 'E') {
                if (shootCooldown <= 0) {
                    shoot();
                }
            }
        });
        
        window.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = false;
            }
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–∞—Ä—Ç—ã
            if (e.key === 'm' || e.key === 'M') {
                mapCanvas.style.display = mapCanvas.style.display === 'none' ? 'block' : 'none';
            }
        });
        
        // –ö–Ω–æ–ø–∫–∞ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
        restartButton.addEventListener('click', restartGame);
        restartButtonWin.addEventListener('click', restartGame);
        
        // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
        function checkCollision(x, y) {
            const mapX = Math.floor(x / tileSize);
            const mapY = Math.floor(y / tileSize);
            
            if (mapX < 0 || mapX >= mapSize || mapY < 0 || mapY >= mapSize) {
                return true;
            }
            
            return map[mapY][mapX] !== 0;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
        function updatePlayer() {
            // –ü–æ–≤–æ—Ä–æ—Ç
            if (keys.ArrowLeft) {
                playerAngle -= rotationSpeed;
            }
            if (keys.ArrowRight) {
                playerAngle += rotationSpeed;
            }
            
            // –î–≤–∏–∂–µ–Ω–∏–µ
            let moveX = 0;
            let moveY = 0;
            
            if (keys.w) {
                moveX += Math.cos(playerAngle) * playerSpeed;
                moveY += Math.sin(playerAngle) * playerSpeed;
            }
            if (keys.s) {
                moveX -= Math.cos(playerAngle) * playerSpeed;
                moveY -= Math.sin(playerAngle) * playerSpeed;
            }
            if (keys.a) {
                moveX += Math.cos(playerAngle - Math.PI/2) * playerSpeed;
                moveY += Math.sin(playerAngle - Math.PI/2) * playerSpeed;
            }
            if (keys.d) {
                moveX += Math.cos(playerAngle + Math.PI/2) * playerSpeed;
                moveY += Math.sin(playerAngle + Math.PI/2) * playerSpeed;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
            if (!checkCollision(playerX + moveX, playerY)) {
                playerX += moveX;
            }
            if (!checkCollision(playerX, playerY + moveY)) {
                playerY += moveY;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏ –æ—Ä—É–∂–∏—è
            if (shootCooldown > 0) {
                shootCooldown -= 16;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–ø–∞–≤–Ω–∞ –≤—Ä–∞–≥–æ–≤
        function spawnEnemy() {
            let x, y;
            let validPosition = false;
            
            // –ò—â–µ–º –≤–∞–ª–∏–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –ø–æ–¥–∞–ª—å—à–µ –æ—Ç –∏–≥—Ä–æ–∫–∞
            while (!validPosition) {
                x = Math.floor(Math.random() * (mapSize - 2) + 1) * tileSize + tileSize/2;
                y = Math.floor(Math.random() * (mapSize - 2) + 1) * tileSize + tileSize/2;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è –Ω–µ –≤ —Å—Ç–µ–Ω–µ –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–ª–µ–∫–æ –æ—Ç –∏–≥—Ä–æ–∫–∞
                const distToPlayer = Math.sqrt((x - playerX)**2 + (y - playerY)**2);
                if (!checkCollision(x, y) && distToPlayer > 5 * tileSize) {
                    validPosition = true;
                }
            }
            
            enemies.push({
                x: x,
                y: y,
                health: 1
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤
        function updateEnemies() {
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                
                // –î–≤–∏–∂–µ–Ω–∏–µ –∫ –∏–≥—Ä–æ–∫—É
                const angleToPlayer = Math.atan2(playerY - enemy.y, playerX - enemy.x);
                enemy.x += Math.cos(angleToPlayer) * enemySpeed;
                enemy.y += Math.sin(angleToPlayer) * enemySpeed;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∏–≥—Ä–æ–∫–æ–º
                const distToPlayer = Math.sqrt((enemy.x - playerX)**2 + (enemy.y - playerY)**2);
                if (distToPlayer < tileSize/2 && !playerInvulnerable) {
                    playerHealth--;
                    updateHealthDisplay();
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç –∫—Ä–æ–≤–∏
                    bloodEffect.style.opacity = 1;
                    setTimeout(() => {
                        bloodEffect.style.opacity = 0;
                    }, 300);
                    
                    // –í—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å
                    playerInvulnerable = true;
                    setTimeout(() => {
                        playerInvulnerable = false;
                    }, 1000);
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—Ä—Ç–∏ –∏–≥—Ä–æ–∫–∞
                    if (playerHealth <= 0) {
                        gameOverScreen.style.display = 'flex';
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                if (enemy.x < 0 || enemy.x > mapSize * tileSize || 
                    enemy.y < 0 || enemy.y > mapSize * tileSize) {
                    enemies.splice(i, 1);
                }
            }
            
            // –°–ø–∞–≤–Ω –Ω–æ–≤—ã—Ö –≤—Ä–∞–≥–æ–≤
            enemySpawnTimer += 16;
            if (enemySpawnTimer >= enemySpawnInterval) {
                spawnEnemy();
                enemySpawnTimer = 0;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã (–µ—Å–ª–∏ –≤—Ä–∞–≥–æ–≤ –Ω–µ—Ç –∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏)
            if (enemies.length === 0 && enemySpawnTimer > 5000) {
                gameWinScreen.style.display = 'flex';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Å—Ç—Ä–µ–ª–∞
        function shoot() {
            shootCooldown = shootCooldownTime;
            isShooting = true;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–¥–∞—á–∏ –æ—Ä—É–∂–∏—è
            weaponElement.classList.add('shooting');
            setTimeout(() => {
                weaponElement.classList.remove('shooting');
                isShooting = false;
            }, 100);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤–æ –≤—Ä–∞–≥–æ–≤
            const shootAngle = playerAngle;
            const shootRange = 300;
            
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                
                // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª –∫ –≤—Ä–∞–≥—É
                const angleToEnemy = Math.atan2(enemy.y - playerY, enemy.x - playerX);
                
                // –†–∞–∑–Ω–∏—Ü–∞ —É–≥–ª–æ–≤ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–µ–±–æ–ª—å—à–æ–π –¥–ª—è –ø–æ–ø–∞–¥–∞–Ω–∏—è)
                let angleDiff = Math.abs(shootAngle - angleToEnemy);
                if (angleDiff > Math.PI) {
                    angleDiff = 2 * Math.PI - angleDiff;
                }
                
                // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –≤—Ä–∞–≥–∞
                const distToEnemy = Math.sqrt((enemy.x - playerX)**2 + (enemy.y - playerY)**2);
                
                // –ï—Å–ª–∏ –≤—Ä–∞–≥ –≤ –∑–æ–Ω–µ –ø–æ—Ä–∞–∂–µ–Ω–∏—è
                if (angleDiff < 0.2 && distToEnemy < shootRange) {
                    // –ü–æ–ø–∞–¥–∞–Ω–∏–µ!
                    enemy.health--;
                    
                    if (enemy.health <= 0) {
                        enemies.splice(i, 1);
                    }
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è
        function updateHealthDisplay() {
            let healthText = '';
            for (let i = 0; i < playerHealth; i++) {
                healthText += '‚ù§Ô∏è';
            }
            healthDisplay.innerHTML = healthText;
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        function render() {
            // –û—á–∏—Å—Ç–∫–∞ —ç–∫—Ä–∞–Ω–∞
            ctx.fillStyle = ceilingColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height / 2);
            
            ctx.fillStyle = floorColor;
            ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);
            
            // Raycasting
            const fov = Math.PI / 3; // 60 –≥—Ä–∞–¥—É—Å–æ–≤
            const rayCount = canvas.width;
            const rayStep = fov / rayCount;
            
            for (let i = 0; i < rayCount; i++) {
                const rayAngle = playerAngle - fov / 2 + i * rayStep;
                
                let distance = 0;
                let hitWall = false;
                let wallSide = '';
                
                // –¢–µ–∫—Å—Ç—É—Ä—ã (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–µ)
                let wallX = 0;
                
                while (!hitWall && distance < mapSize * tileSize) {
                    distance += 1;
                    
                    const rayX = playerX + Math.cos(rayAngle) * distance;
                    const rayY = playerY + Math.sin(rayAngle) * distance;
                    
                    const mapX = Math.floor(rayX / tileSize);
                    const mapY = Math.floor(rayY / tileSize);
                    
                    if (mapX < 0 || mapX >= mapSize || mapY < 0 || mapY >= mapSize) {
                        hitWall = true;
                        distance = mapSize * tileSize;
                    } else if (map[mapY][mapX] !== 0) {
                        hitWall = true;
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ—Ä–æ–Ω—É —Å—Ç–µ–Ω—ã
                        const blockX = mapX * tileSize;
                        const blockY = mapY * tileSize;
                        
                        // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å –±–ª–æ–∫–æ–º
                        const testPointX = (rayX - blockX) / tileSize;
                        const testPointY = (rayY - blockY) / tileSize;
                        
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤ –∫–∞–∫—É—é –≥—Ä–∞–Ω—å –ø–æ–ø–∞–ª –ª—É—á
                        if (testPointX < 0.01) {
                            wallSide = 'west';
                            wallX = rayY - blockY;
                        } else if (testPointX > 0.99) {
                            wallSide = 'east';
                            wallX = rayY - blockY;
                        } else if (testPointY < 0.01) {
                            wallSide = 'north';
                            wallX = rayX - blockX;
                        } else if (testPointY > 0.99) {
                            wallSide = 'south';
                            wallX = rayX - blockX;
                        }
                        
                        wallX = wallX - Math.floor(wallX);
                    }
                }
                
                // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è "—Ä—ã–±–∏–π –≥–ª–∞–∑"
                const correctedDistance = distance * Math.cos(rayAngle - playerAngle);
                
                // –í—ã—Å–æ—Ç–∞ —Å—Ç–µ–Ω—ã
                const wallHeight = Math.min(5000, (tileSize / correctedDistance) * ((canvas.width / 2) / Math.tan(fov / 2)));
                
                // –†–∏—Å—É–µ–º —Å—Ç–µ–Ω—É
                ctx.fillStyle = wallColors[wallSide];
                
                // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
                const darkness = Math.min(1, correctedDistance / (tileSize * 8));
                ctx.fillStyle = darkenColor(ctx.fillStyle, darkness);
                
                ctx.fillRect(
                    i, 
                    canvas.height / 2 - wallHeight / 2, 
                    1, 
                    wallHeight
                );
            }
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –º–∏–Ω–∏-–∫–∞—Ä—Ç—É
            renderMinimap();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞
        function darkenColor(color, amount) {
            // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏)
            if (color === wallColors.north) return `rgb(${139 * (1 - amount)}, 0, 0)`;
            if (color === wallColors.south) return `rgb(${165 * (1 - amount)}, ${42 * (1 - amount)}, ${42 * (1 - amount)})`;
            if (color === wallColors.east) return `rgb(${178 * (1 - amount)}, ${34 * (1 - amount)}, ${34 * (1 - amount)})`;
            if (color === wallColors.west) return `rgb(${128 * (1 - amount)}, 0, 0)`;
            return color;
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–∏–Ω–∏-–∫–∞—Ä—Ç—ã
        function renderMinimap() {
            const cellSize = mapCanvas.width / mapSize;
            
            // –û—á–∏—â–∞–µ–º –º–∏–Ω–∏-–∫–∞—Ä—Ç—É
            mapCtx.fillStyle = '#000';
            mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height);
            
            // –†–∏—Å—É–µ–º —Å—Ç–µ–Ω—ã
            for (let y = 0; y < mapSize; y++) {
                for (let x = 0; x < mapSize; x++) {
                    if (map[y][x] !== 0) {
                        mapCtx.fillStyle = '#f00';
                        mapCtx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                    }
                }
            }
            
            // –†–∏—Å—É–µ–º –≤—Ä–∞–≥–æ–≤
            mapCtx.fillStyle = '#00f';
            for (const enemy of enemies) {
                const enemyMapX = (enemy.x / tileSize) * cellSize;
                const enemyMapY = (enemy.y / tileSize) * cellSize;
                
                mapCtx.beginPath();
                mapCtx.arc(enemyMapX, enemyMapY, cellSize / 4, 0, Math.PI * 2);
                mapCtx.fill();
            }
            
            // –†–∏—Å—É–µ–º –∏–≥—Ä–æ–∫–∞
            const playerMapX = (playerX / tileSize) * cellSize;
            const playerMapY = (playerY / tileSize) * cellSize;
            
            mapCtx.fillStyle = '#0f0';
            mapCtx.beginPath();
            mapCtx.arc(playerMapX, playerMapY, cellSize / 3, 0, Math.PI * 2);
            mapCtx.fill();
            
            // –†–∏—Å—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
            mapCtx.strokeStyle = '#0f0';
            mapCtx.beginPath();
            mapCtx.moveTo(playerMapX, playerMapY);
            mapCtx.lineTo(
                playerMapX + Math.cos(playerAngle) * cellSize,
                playerMapY + Math.sin(playerAngle) * cellSize
            );
            mapCtx.stroke();
        }
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        function restartGame() {
            playerX = 1.5 * tileSize;
            playerY = 1.5 * tileSize;
            playerAngle = 0;
            playerHealth = 3;
            playerInvulnerable = false;
            enemies = [];
            enemySpawnTimer = 0;
            shootCooldown = 0;
            
            updateHealthDisplay();
            
            gameOverScreen.style.display = 'none';
            gameWinScreen.style.display = 'none';
            bloodEffect.style.opacity = 0;
        }
        
        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            updatePlayer();
            updateEnemies();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        updateHealthDisplay();
        spawnEnemy(); // –°–ø–∞–≤–Ω–∏–º –ø–µ—Ä–≤–æ–≥–æ –≤—Ä–∞–≥–∞
        gameLoop();
    </script>
</body>
</html>
